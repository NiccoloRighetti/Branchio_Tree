# BRANCHIO PLOTTING
# Needed packages
library(MCMCtreeR, quietly = TRUE, warn.conflicts = FALSE)
library(readr)
library(ape)
library(scales)
library(ggplot2)
library(tm)
library(gridExtra)
library(fmsb)
library(devtools)
library(ggradar)
library(cowplot)
library(dplyr)
cat("All required packages have been successfully loaded.\n")

# ALL TREE
all.tree <- as.character(c("#NEXUS","begin trees","","((Scur: 3.634059, Iele: 3.634059) [&95%={0.737279, 5.08848}]: 1.324361, (((Blyn: 0.266181, Blin: 0.266181) [&95%={0.0658616, 0.597975}]: 1.007608, (Afr1: 1.036729, (Bher: 0.707185, (Stsp: 0.609131, Tpla: 0.609131) [&95%={0.330011, 0.880737}]: 0.098054) [&95%={0.401843, 0.965316}]: 0.329544) [&95%={0.777679, 1.17695}]: 0.237060) [&95%={1.25782, 1.30339}]: 2.792129, (((Tlon: 0.855106, (Tita: 0.294715, (Tusa: 0.060144, Tjap: 0.060144) [&95%={0.020136, 0.137451}]: 0.234571) [&95%={0.134932, 0.50772}]: 0.560391) [&95%={0.62279, 1.03039}]: 0.380029, ((Lcry: 0.315365, Lpac: 0.315365) [&95%={0.148522, 0.536336}]: 0.400666, (Lubb: 0.370249, (Lapu: 0.310294, (Lcou: 0.137258, Lart: 0.137258) [&95%={0.0653136, 0.255869}]: 0.173035) [&95%={0.175744, 0.490623}]: 0.059955) [&95%={0.218267, 0.559086}]: 0.345782) [&95%={0.516854, 0.904909}]: 0.519104) [&95%={1.21872, 1.26526}]: 1.987149, (Lysp: 2.740275, (((Orub: 0.570989, (Ozsp: 0.481092, Cpil: 0.481092) [&95%={0.196043, 0.91723}]: 0.089897) [&95%={0.240827, 1.03756}]: 0.812647, ((Eosp: 0.983066, (Ldah: 0.508189, Etic: 0.508189) [&95%={0.209599, 0.900334}]: 0.474877) [&95%={0.597835, 1.38715}]: 0.170545, ((Mesp: 0.415036, Etex: 0.415036) [&95%={0.165884, 0.774029}]: 0.412751, (Puru: 0.393182, (Lpar: 0.205961, Lbir: 0.205961) [&95%={0.0720999, 0.442125}]: 0.187221) [&95%={0.155502, 0.738493}]: 0.434606) [&95%={0.451611, 1.2405}]: 0.325824) [&95%={0.733726, 1.56866}]: 0.230024) [&95%={0.920754, 1.8293}]: 0.972400, ((Chis: 0.736458, C146: 0.736458) [&95%={0.186309, 1.28747}]: 1.220668, (Scry: 1.745134, ((Pped: 1.241071, (Pleu: 0.724312, Enor: 0.724312) [&95%={0.296855, 1.17707}]: 0.516759) [&95%={0.829608, 1.51031}]: 0.346428, ((Bosp: 1.177837, (Elam: 0.257397, Aema: 0.257397) [&95%={0.0847145, 0.564084}]: 0.920440) [&95%={0.874826, 1.40847}]: 0.254409, (Mosp: 1.051237, (Masp: 0.979396, ((Cqua: 0.725484, (Svet: 0.313429, Smuc: 0.313429) [&95%={0.180215, 0.500434}]: 0.412055) [&95%={0.514604, 0.951929}]: 0.090934, (Dmag: 0.569249, (Dgal: 0.350995, (Dpul: 0.059634, Dpli: 0.059634) [&95%={0.0214312, 0.138137}]: 0.291361) [&95%={0.176489, 0.575961}]: 0.218254) [&95%={0.349793, 0.805346}]: 0.247170) [&95%={0.595635, 1.04098}]: 0.162978) [&95%={0.739202, 1.19704}]: 0.071841) [&95%={0.807219, 1.25929}]: 0.381009) [&95%={1.22321, 1.5701}]: 0.155253) [&95%={1.42735, 1.67234}]: 0.157635) [&95%={1.73152, 1.77082}]: 0.211992) [&95%={1.83139, 2.22748}]: 0.398909) [&95%={2.02756, 2.89972}]: 0.384239) [&95%={2.23434, 3.37384}]: 0.482009) [&95%={2.52256, 3.76637}]: 0.843633) [&95%={4.0506, 4.09484}]: 0.892502) [&95%={4.73972, 5.28311}];","END;"))
all.tree <- readMCMCtree(all.tree, from.file = FALSE)
# NO LYSP TREE
nolysp.tree <- as.character(c("#NEXUS","begin trees","","((Scur: 4.567391, Iele: 4.567391) [&95%={3.64554, 5.13013}]: 0.348361, (((Blyn: 0.184843, Blin: 0.184843) [&95%={0.0858299, 0.35493}]: 1.090215, (Afr1: 1.051796, (Bher: 0.741638, (Stsp: 0.598639, Tpla: 0.598639) [&95%={0.383803, 0.812534}]: 0.142999) [&95%={0.525328, 0.944971}]: 0.310158) [&95%={0.872574, 1.18086}]: 0.223263) [&95%={1.25792, 1.3051}]: 2.791021, (((Tlon: 0.462610, (Tita: 0.041969, (Tusa: 0.004952, Tjap: 0.004952) [&95%={0.0022598, 0.0097788}]: 0.037018) [&95%={0.0205872, 0.0784247}]: 0.420641) [&95%={0.220289, 0.809126}]: 0.769301, ((Lcry: 0.072841, Lpac: 0.072841) [&95%={0.0337677, 0.13588}]: 0.162456, (Lubb: 0.085198, (Lapu: 0.071107, (Lcou: 0.035190, Lart: 0.035190) [&95%={0.0180125, 0.0614742}]: 0.035917) [&95%={0.0431286, 0.112514}]: 0.014091) [&95%={0.0539564, 0.13048}]: 0.150099) [&95%={0.140888, 0.38818}]: 0.996614) [&95%={1.21846, 1.25891}]: 2.160812, (((Orub: 0.372032, (Ozsp: 0.300639, Cpil: 0.300639) [&95%={0.154036, 0.529116}]: 0.071392) [&95%={0.211617, 0.617533}]: 1.014036, ((Eosp: 0.946259, (Ldah: 0.492319, Etic: 0.492319) [&95%={0.256267, 0.792326}]: 0.453940) [&95%={0.662401, 1.25751}]: 0.200535, ((Mesp: 0.395340, Etex: 0.395340) [&95%={0.204383, 0.654474}]: 0.422721, (Puru: 0.373784, (Lpar: 0.195066, Lbir: 0.195066) [&95%={0.0979167, 0.342675}]: 0.178718) [&95%={0.224651, 0.583563}]: 0.444278) [&95%={0.578456, 1.11411}]: 0.328732) [&95%={0.879065, 1.48532}]: 0.239273) [&95%={1.07467, 1.75469}]: 1.198566, ((Chis: 0.533181, C146: 0.533181) [&95%={0.249461, 0.988192}]: 1.522667, (Scry: 1.746470, ((Pped: 1.154910, (Pleu: 0.656304, Enor: 0.656304) [&95%={0.366702, 0.983572}]: 0.498606) [&95%={0.850184, 1.41319}]: 0.435528, ((Bosp: 1.010615, (Elam: 0.144883, Aema: 0.144883) [&95%={0.0686215, 0.273411}]: 0.865732) [&95%={0.670336, 1.26609}]: 0.408303, (Mosp: 1.088681, (Masp: 0.959763, ((Cqua: 0.610416, (Svet: 0.222972, Smuc: 0.222972) [&95%={0.116499, 0.36949}]: 0.387444) [&95%={0.433069, 0.801926}]: 0.152172, (Dmag: 0.490721, (Dgal: 0.272830, (Dpul: 0.039483, Dpli: 0.039483) [&95%={0.0183203, 0.0755962}]: 0.233347) [&95%={0.150985, 0.434955}]: 0.217892) [&95%={0.329441, 0.68024}]: 0.271867) [&95%={0.588221, 0.949893}]: 0.197175) [&95%={0.768085, 1.14641}]: 0.128918) [&95%={0.888471, 1.26362}]: 0.330237) [&95%={1.22793, 1.55935}]: 0.171520) [&95%={1.44521, 1.68289}]: 0.156032) [&95%={1.73168, 1.7732}]: 0.309378) [&95%={1.85483, 2.40355}]: 0.528785) [&95%={2.17856, 3.10576}]: 0.808090) [&95%={2.83985, 3.81931}]: 0.673356) [&95%={4.05065, 4.09525}]: 0.849673) [&95%={4.73423, 5.26081}];","END;"))
nolysp.tree <- readMCMCtree(nolysp.tree, from.file = FALSE)
# CONC vs DISC PLOT
# CONCORDANCE SUBSET
conc.tree <- as.character(c("#NEXUS","begin trees","","((Scur: 4.657473, Iele: 4.657473) [&95%={3.94617, 5.13342}]: 0.237328, (((Blyn: 0.172999, Blin: 0.172999) [&95%={0.0832141, 0.32186}]: 1.101822, (Afr1: 1.003902, (Bher: 0.696365, (Stsp: 0.574730, Tpla: 0.574730) [&95%={0.362662, 0.794209}]: 0.121635) [&95%={0.485634, 0.905362}]: 0.307537) [&95%={0.810452, 1.15217}]: 0.270918) [&95%={1.25783, 1.3049}]: 2.791594, (((Tlon: 0.436908, (Tita: 0.043189, (Tusa: 0.002764, Tjap: 0.002764) [&95%={0.0011045, 0.0057511}]: 0.040425) [&95%={0.0213052, 0.080165}]: 0.393719) [&95%={0.222156, 0.757916}]: 0.794889, ((Lcry: 0.063525, Lpac: 0.063525) [&95%={0.0332871, 0.108178}]: 0.083939, (Lubb: 0.083636, (Lapu: 0.068637, (Lcou: 0.038697, Lart: 0.038697) [&95%={0.0204121, 0.0660195}]: 0.029940) [&95%={0.0425198, 0.105652}]: 0.014999) [&95%={0.0539449, 0.123781}]: 0.063828) [&95%={0.0984385, 0.222605}]: 1.084332) [&95%={1.21849, 1.25838}]: 2.184840, (Lysp: 2.989636, (((Orub: 0.306319, (Ozsp: 0.216625, Cpil: 0.216625) [&95%={0.113564, 0.376694}]: 0.089694) [&95%={0.181347, 0.496661}]: 1.028830, ((Eosp: 0.873837, (Ldah: 0.417190, Etic: 0.417190) [&95%={0.223382, 0.672081}]: 0.456646) [&95%={0.622116, 1.16084}]: 0.191597, ((Mesp: 0.314854, Etex: 0.314854) [&95%={0.163871, 0.527439}]: 0.416666, (Puru: 0.289850, (Lpar: 0.139600, Lbir: 0.139600) [&95%={0.0699387, 0.248232}]: 0.150250) [&95%={0.172203, 0.456414}]: 0.441670) [&95%={0.512911, 1.00495}]: 0.333913) [&95%={0.818579, 1.36041}]: 0.269716) [&95%={1.03797, 1.72175}]: 1.174917, ((Chis: 0.471796, C146: 0.471796) [&95%={0.228357, 0.871197}]: 1.579175, (Scry: 1.746430, ((Pped: 1.143439, (Pleu: 0.618958, Enor: 0.618958) [&95%={0.349409, 0.928247}]: 0.524480) [&95%={0.849642, 1.38322}]: 0.420535, ((Bosp: 1.032847, (Elam: 0.174691, Aema: 0.174691) [&95%={0.0833779, 0.32239}]: 0.858156) [&95%={0.728025, 1.26575}]: 0.347078, (Mosp: 1.065743, (Masp: 0.930338, ((Cqua: 0.593207, (Svet: 0.215158, Smuc: 0.215158) [&95%={0.116673, 0.348629}]: 0.378049) [&95%={0.430428, 0.769722}]: 0.122899, (Dmag: 0.477778, (Dgal: 0.247792, (Dpul: 0.035352, Dpli: 0.035352) [&95%={0.0167884, 0.0658592}]: 0.212440) [&95%={0.140355, 0.392941}]: 0.229986) [&95%={0.324277, 0.657726}]: 0.238329) [&95%={0.556912, 0.891048}]: 0.214232) [&95%={0.74895, 1.11535}]: 0.135405) [&95%={0.874277, 1.24861}]: 0.314182) [&95%={1.20429, 1.5308}]: 0.184049) [&95%={1.41125, 1.66631}]: 0.182456) [&95%={1.73167, 1.7729}]: 0.304540) [&95%={1.86345, 2.3508}]: 0.459096) [&95%={2.1755, 2.92472}]: 0.479570) [&95%={2.55061, 3.41865}]: 0.427000) [&95%={2.95647, 3.78177}]: 0.649779) [&95%={4.05067, 4.09584}]: 0.828386) [&95%={4.73238, 5.24305}];","END;"))
conc.tree <- readMCMCtree(conc.tree, from.file = FALSE)
# DISCORDANCE SUBSET
disc.tree <- as.character(c("#NEXUS","begin trees","","((Scur: 4.530216, Iele: 4.530216) [&95%={3.50759, 5.11733}]: 0.388044, (((Blyn: 0.188104, Blin: 0.188104) [&95%={0.0870292, 0.354397}]: 1.086949, (Afr1: 1.062181, (Bher: 0.750673, (Stsp: 0.606218, Tpla: 0.606218) [&95%={0.391139, 0.820205}]: 0.144455) [&95%={0.536051, 0.954248}]: 0.311508) [&95%={0.88346, 1.18513}]: 0.212872) [&95%={1.25781, 1.30552}]: 2.790946, (((Tlon: 0.465635, (Tita: 0.042319, (Tusa: 0.005369, Tjap: 0.005369) [&95%={0.0023955, 0.01052}]: 0.036950) [&95%={0.0204503, 0.0801272}]: 0.423316) [&95%={0.225127, 0.81719}]: 0.766473, ((Lcry: 0.074542, Lpac: 0.074542) [&95%={0.0341164, 0.141615}]: 0.176003, (Lubb: 0.086739, (Lapu: 0.072465, (Lcou: 0.035149, Lart: 0.035149) [&95%={0.0176846, 0.062038}]: 0.037316) [&95%={0.043702, 0.114529}]: 0.014275) [&95%={0.054889, 0.133347}]: 0.163806) [&95%={0.150861, 0.418443}]: 0.981563) [&95%={1.21852, 1.25956}]: 2.207889, (Lysp: 2.953219, (((Orub: 0.382588, (Ozsp: 0.314786, Cpil: 0.314786) [&95%={0.161993, 0.544004}]: 0.067801) [&95%={0.220267, 0.623462}]: 1.006771, ((Eosp: 0.958481, (Ldah: 0.509653, Etic: 0.509653) [&95%={0.274869, 0.814632}]: 0.448828) [&95%={0.675199, 1.26746}]: 0.199781, ((Mesp: 0.410152, Etex: 0.410152) [&95%={0.2101, 0.679922}]: 0.419426, (Puru: 0.387658, (Lpar: 0.203974, Lbir: 0.203974) [&95%={0.101437, 0.360474}]: 0.183684) [&95%={0.228108, 0.609368}]: 0.441920) [&95%={0.578498, 1.13412}]: 0.328684) [&95%={0.888493, 1.49706}]: 0.231098) [&95%={1.07809, 1.77058}]: 1.146764, ((Chis: 0.538475, C146: 0.538475) [&95%={0.252326, 0.991484}]: 1.508140, (Scry: 1.746554, ((Pped: 1.163299, (Pleu: 0.666849, Enor: 0.666849) [&95%={0.373534, 0.989712}]: 0.496450) [&95%={0.853303, 1.42225}]: 0.433215, ((Bosp: 1.001168, (Elam: 0.139617, Aema: 0.139617) [&95%={0.0631935, 0.267611}]: 0.861551) [&95%={0.661894, 1.26338}]: 0.425886, (Mosp: 1.099781, (Masp: 0.972166, ((Cqua: 0.621304, (Svet: 0.227028, Smuc: 0.227028) [&95%={0.118746, 0.372019}]: 0.394276) [&95%={0.439994, 0.816198}]: 0.156004, (Dmag: 0.498695, (Dgal: 0.279543, (Dpul: 0.040579, Dpli: 0.040579) [&95%={0.0183754, 0.0786564}]: 0.238964) [&95%={0.156024, 0.44855}]: 0.219152) [&95%={0.33125, 0.692543}]: 0.278613) [&95%={0.599195, 0.964667}]: 0.194858) [&95%={0.778703, 1.15955}]: 0.127615) [&95%={0.89956, 1.26757}]: 0.327274) [&95%={1.23139, 1.56527}]: 0.169460) [&95%={1.45356, 1.68687}]: 0.150039) [&95%={1.73168, 1.77367}]: 0.300062) [&95%={1.85237, 2.3881}]: 0.489508) [&95%={2.16576, 3.00678}]: 0.417096) [&95%={2.49527, 3.43611}]: 0.486777) [&95%={2.9292, 3.83708}]: 0.626003) [&95%={4.05067, 4.09467}]: 0.852261) [&95%={4.73468, 5.26021}];","END;"))
disc.tree <- readMCMCtree(disc.tree, from.file = FALSE)

dates <- as.data.frame(cbind(conc.tree$nodeAges[,1],disc.tree$nodeAges[,1],all.tree$nodeAges[,1]))
colnames(dates) <- c("mean_conc","mean_disc","mean_all")
library(ggplot2)
plot1 <- ggplot(dates,aes(x=mean_conc*100, y=mean_disc*100)) +
  geom_point() +
  ggtitle("Concordance Dataset vs Discordance Dataset") +
  labs(x = "Date estimates with concordant genes", y = "Date estimates discordant genes") +
  geom_abline(slope = 1, intercept = 0, lty=2, color = "#008080") +
  geom_errorbar(aes(xmin=conc.tree$nodeAges[,2]*100, xmax=conc.tree$nodeAges[,3]*100), width = 0.05, lty=2,col="salmon") +
  geom_errorbar(aes(ymin=disc.tree$nodeAges[,2]*100, ymax=disc.tree$nodeAges[,3]*100), width = 0.05, lty=2,col="salmon")
plot2 <- ggplot(dates,aes(x=mean_all*100, y=mean_disc*100)) +
  geom_point() +
  ggtitle("Complete Dataset vs Discordance Dataset") +
  labs(x = "Date estimates with all genes", y = "Date estimates discordant genes") +
  geom_abline(slope = 1, intercept = 0, lty=2, color = "#008080") +
  geom_errorbar(aes(xmin=all.tree$nodeAges[,2]*100, xmax=all.tree$nodeAges[,3]*100), width = 0.05, lty=2,col="salmon") +
  geom_errorbar(aes(ymin=disc.tree$nodeAges[,2]*100, ymax=disc.tree$nodeAges[,3]*100), width = 0.05, lty=2,col="salmon")
plot3 <- ggplot(dates,aes(x=mean_all*100, y=mean_conc*100)) +
  geom_point() +
  ggtitle("Complete Dataset vs Concordance Dataset") +
  labs(x = "Date estimates with all genes", y = "Date estimates concordant genes") +
  geom_abline(slope = 1, intercept = 0, lty=2, color = "#008080") +
  geom_errorbar(aes(xmin=all.tree$nodeAges[,2]*100, xmax=all.tree$nodeAges[,3]*100), width = 0.05, lty=2,col="salmon") +
  geom_errorbar(aes(ymin=conc.tree$nodeAges[,2]*100, ymax=conc.tree$nodeAges[,3]*100), width = 0.05, lty=2,col="salmon")

pdf("./All_Conc_vs_Disc_scatterplot.pdf", width = 11.7, height = 8.3)
plot_grid(plot2,plot3,plot1,ncol = 2)
dev.off()


pdf("./conc_clock2.pdf", width = 11.7, height = 8.3)
MCMC.tree.plot(phy = conc.tree, analysis.type = "MCMCtree",
               MCMC.chain = NULL, node.ages = NULL, directory.files = NULL,
               plot.type = "phylogram", build.tree = FALSE, node.method = "bar",
               all.nodes = NULL, add.time.scale = TRUE, add.abs.time = TRUE,
               scale.res = c("Period"), label.timescale.names = FALSE,
               time.correction = 100, col.age = ggplot2::alpha("#FDB927", 0.5), tip.lengths = FALSE,
               density.col = "#00000050", density.border.col = "#00000080",
               cex.tips = 0.5, show.tip.label = TRUE, col.tree = "black",
               tip.color = "black", lwd.bar = 4, grey.bars = TRUE, cex.age = 0.7,
               cex.labels = 0.7, cex.names = 1, relative.height = 0.08,
               tip.bar.col = "#ff000050", burn.in = 0.25,
               distribution.height = 0.8, abs.age.mgp = c(3, 0.35, 0),
               abs.age.lwd.ticks = 0.7, abs.age.lwd = 0, tck.abs.age = -0.01,
               abs.age.line = -0.4, pos.age = NULL, n.runs = 2,
               ladderize.tree = TRUE)
dev.off()

pdf("./disc_clock2.pdf", width = 11.7, height = 8.3)
MCMC.tree.plot(phy = disc.tree, analysis.type = "MCMCtree",
               MCMC.chain = NULL, node.ages = NULL, directory.files = NULL,
               plot.type = "phylogram", build.tree = FALSE, node.method = "bar",
               all.nodes = NULL, add.time.scale = TRUE, add.abs.time = TRUE,
               scale.res = c("Period"), label.timescale.names = FALSE,
               time.correction = 100, col.age = ggplot2::alpha("#FDB927", 0.5), tip.lengths = FALSE,
               density.col = "#00000050", density.border.col = "#00000080",
               cex.tips = 0.5, show.tip.label = TRUE, col.tree = "black",
               tip.color = "black", lwd.bar = 4, grey.bars = TRUE, cex.age = 0.7,
               cex.labels = 0.7, cex.names = 1, relative.height = 0.08,
               tip.bar.col = "#ff000050", burn.in = 0.25,
               distribution.height = 0.8, abs.age.mgp = c(3, 0.35, 0),
               abs.age.lwd.ticks = 0.7, abs.age.lwd = 0, tck.abs.age = -0.01,
               abs.age.line = -0.4, pos.age = NULL, n.runs = 2,
               ladderize.tree = TRUE)
dev.off()


pdf("./all_clock2.pdf", width = 11.7, height = 8.3)
MCMC.tree.plot(phy = all.tree, analysis.type = "MCMCtree",
               MCMC.chain = NULL, node.ages = NULL, directory.files = NULL,
               plot.type = "phylogram", build.tree = FALSE, node.method = "bar",
               all.nodes = NULL, add.time.scale = TRUE, add.abs.time = TRUE,
               scale.res = c("Period"), label.timescale.names = FALSE,
               time.correction = 100, col.age = ggplot2::alpha("#FDB927", 0.5), tip.lengths = FALSE,
               density.col = "#00000050", density.border.col = "#00000080",
               cex.tips = 0.5, show.tip.label = TRUE, col.tree = "black",
               tip.color = "black", lwd.bar = 4, grey.bars = TRUE, cex.age = 0.7,
               cex.labels = 0.7, cex.names = 1, relative.height = 0.08,
               tip.bar.col = "#ff000050", burn.in = 0.25,
               distribution.height = 0.8, abs.age.mgp = c(3, 0.35, 0),
               abs.age.lwd.ticks = 0.7, abs.age.lwd = 0, tck.abs.age = -0.01,
               abs.age.line = -0.4, pos.age = NULL, n.runs = 2,
               ladderize.tree = TRUE)
dev.off()
